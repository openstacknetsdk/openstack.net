<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <Platform>Mixed Platforms</Platform>
    <DocumentationPlatform>Any CPU</DocumentationPlatform>
    <Version>1.3.6.0</Version>

    <NuGet>$(LocalAppData)\NuGet\NuGet.exe</NuGet>
    <MSBuild>&quot;$(MSBuildToolsPath)\MSBuild.exe&quot;</MSBuild>
  </PropertyGroup>
  
  <!-- ========================== -->  
  <!-- MAIN EXECUTABLE TARGETS    -->
  <!-- ========================== -->  
  <Target Name="BuildDebug">
    <CallTarget Targets="SetDebugConfiguration" />
    <CallTarget Targets="ExecuteBuild" />
  </Target>

  <Target Name="BuildRelease">
    <CallTarget Targets="SetReleaseConfiguration" />
    <CallTarget Targets="ExecuteBuild" />
  </Target>
  
  <Target Name="BuildDebugAndPackage">
    <CallTarget Targets="SetDebugConfiguration" />
    <CallTarget Targets="ExecuteBuildAndPackage" />
  </Target>
  
  <Target Name="BuildReleaseAndPackage">
    <CallTarget Targets="SetReleaseConfiguration" />
    <CallTarget Targets="ExecuteBuildAndPackage" />
  </Target>
  
  <Target Name="BuildReleaseAndPackageAndPublish">
    <CallTarget Targets="SetReleaseConfiguration" />
    <CallTarget Targets="ExecuteBuildAndPackageAndPublish" />
  </Target>
  
  <!-- ========================== -->  
  <!-- SUPPORTING TARGETS         -->
  <!-- ========================== -->  
  <Target Name="SetDebugConfiguration">
    <PropertyGroup>
      <Configuration>Debug</Configuration>
    </PropertyGroup>
  </Target>
  
  <Target Name="SetReleaseConfiguration">
    <PropertyGroup>
      <Configuration>Release</Configuration>
    </PropertyGroup>
  </Target>
  
  <Target Name="ExecuteBuild">
    <CallTarget Targets="Build" />
    <CallTarget Targets="UnitTest" />
  </Target>
  
  <Target Name="ExecuteBuildAndPackage">
    <CallTarget Targets="ExecuteBuild" />
    <CallTarget Targets="Documentation" />
    <CallTarget Targets="Package" />
  </Target>
  
  <Target Name="ExecuteBuildAndPackageAndPublish">
    <CallTarget Targets="ExecuteBuildAndPackage" />
    <CallTarget Targets="Publish" />
  </Target>
  
  <!-- ========================== -->  
  <!-- WORKING TARGETS            -->
  <!-- ========================== -->    
  <Target Name="Build" DependsOnTargets="RestorePackages">
    <Exec Command="$(MSBuild) ..\src\openstack.net.sln /p:Configuration=$(Configuration) /p:Platform=&quot;$(Platform)&quot; /nologo /v:minimal" WorkingDirectory="$(MSBuildThisFileDirectory)" />
  </Target>

  <Target Name="Documentation" DependsOnTargets="Build">
    <PropertyGroup>
      <SHFBROOT>$(MSBuildThisFileDirectory.Replace('build\','src'))\packages\EWSoftware.SHFB.2014.11.22-beta\tools</SHFBROOT>
    </PropertyGroup>

    <Exec Command="$(NuGet) restore ..\src\Documentation\Documentation.sln" WorkingDirectory="$(MSBuildThisFileDirectory)" />
    <Exec Command="(set SHFBROOT=$(SHFBROOT)) &amp; $(MSBuild) ..\src\Documentation\Documentation.sln /p:Configuration=$(Configuration) /p:Platform=&quot;$(DocumentationPlatform)&quot; /nologo /v:minimal" WorkingDirectory="$(MSBuildThisFileDirectory)" />
  </Target>

  <Target Name="RestorePackages" DependsOnTargets="DownloadNuGet">
    <Exec Command="$(NuGet) restore ..\src\openstack.net.sln" WorkingDirectory="$(MSBuildThisFileDirectory)" />
  </Target>

  <Target Name="DownloadNuGet" Condition="!Exists('$(NuGet)')">
    <MakeDir Directories="$(LocalAppData)\NuGet" />
    <Exec Command="@powershell -NoProfile -ExecutionPolicy unrestricted -Command &quot;$ProgressPreference = 'SilentlyContinue'; Invoke-WebRequest 'https://www.nuget.org/nuget.exe' -OutFile '$(NuGet)'&quot;" />
  </Target>

  <Target Name="UnitTest" DependsOnTargets="Build">
    <PropertyGroup>
      <MSTest Condition=" '$(VS140COMNTOOLS)' != '' ">&quot;$(VS140COMNTOOLS)..\IDE\MSTest.exe&quot;</MSTest>
      <MSTest Condition=" '$(VS120COMNTOOLS)' != '' ">&quot;$(VS120COMNTOOLS)..\IDE\MSTest.exe&quot;</MSTest>
    </PropertyGroup>

    <MakeDir Directories="..\artifacts\TestResults\" />
    <Exec Command="$(MSTest) /testcontainer:..\src\testing\unit\bin\$(Configuration)\OpenStackNet.Testing.Unit.dll /category:Unit /resultsfile:..\artifacts\TestResults\unit.trx" ContinueOnError="true" WorkingDirectory="$(MSBuildThisFileDirectory)" />
    <!--<Exec Command="$(MSTest) /testcontainer:..\src\testing\integration\bin\$(Configuration)\OpenStackNet.Testing.Integration.dll /resultsfile:..\artifacts\TestResults\integration.trx" ContinueOnError="true" WorkingDirectory="$(MSBuildThisFileDirectory)" /> -->
  </Target>

  <Target Name="Package" DependsOnTargets="Build">
    <MakeDir Directories="..\artifacts\packages\" />
    <Exec Command="$(NuGet) pack ..\src\corelib\corelib.nuspec -OutputDirectory ..\artifacts\packages -Prop Configuration=$(Configuration) -Version $(Version) -Symbols" WorkingDirectory="$(MSBuildThisFileDirectory)" />
  </Target>

  <Target Name="Publish" DependsOnTargets="DownloadNuGet">
    <!-- The environment variable BAMBOO_NUGET_PASSWORD comes from the nuget.password variable defined on the openstack.net plan in Bamboo -->
    <Exec Command="$(NuGet) push ..\artifacts\packages\openstack.net.$(Version).nupkg %25BAMBOO_NUGET_PASSWORD%25" WorkingDirectory="$(MSBuildThisFileDirectory)" />
  </Target>

</Project>
